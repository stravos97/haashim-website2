---
import Layout from '../layouts/Layout.astro';
import { cvData } from '../data/cvData';

const { personal, skills, experience, projects, education, certifications } = cvData;
---

<Layout title={`${personal.name} - ${personal.title}`}>
  <div class="govuk-width-container">
    <!-- Skip Navigation Links (WCAG 2.2) -->
    <div class="skip-links">
      <a href="#main-content" class="govuk-skip-link">Skip to main content</a>
      <a href="#experience" class="govuk-skip-link">Skip to experience</a>
      <a href="#projects" class="govuk-skip-link">Skip to projects</a>
      <a href="#skills" class="govuk-skip-link">Skip to skills</a>
    </div>
    
    <!-- Header with ARIA Landmarks -->
    <header class="govuk-header" role="banner" aria-label="Site header">
      <div class="govuk-header__content">
        <h1 class="govuk-heading-xl" id="site-title">{personal.name}</h1>
        <p class="govuk-body-l govuk-!-margin-bottom-4" role="doc-subtitle">{personal.title}</p>
        <p class="govuk-body govuk-!-margin-bottom-6" aria-label="Professional summary">{personal.summary}</p>
        
        <nav class="govuk-button-group" role="navigation" aria-label="Contact information">
          <a href={`mailto:${personal.contact.email}`} 
             class="govuk-link touch-target"
             aria-label={`Send email to ${personal.name}`}>
            <span aria-hidden="true">üìß</span> Email: {personal.contact.email}
          </a>
          <span class="separator" aria-hidden="true">|</span>
          <a href={`tel:${personal.contact.phone.replace(/\s/g, '')}`} 
             class="govuk-link touch-target"
             aria-label={`Call ${personal.name}`}>
            <span aria-hidden="true">üì±</span> Phone: {personal.contact.phone}
          </a>
          <span class="separator" aria-hidden="true">|</span>
          <a href={`https://${personal.contact.linkedin}`} 
             class="govuk-link touch-target"
             rel="noopener noreferrer"
             target="_blank"
             aria-label={`View ${personal.name}'s LinkedIn profile (opens in new tab)`}>
            LinkedIn <span class="visually-hidden">(opens in new tab)</span>
          </a>
          <span class="separator" aria-hidden="true">|</span>
          <a href={`https://${personal.contact.github}`} 
             class="govuk-link touch-target"
             rel="noopener noreferrer"
             target="_blank"
             aria-label={`View ${personal.name}'s GitHub profile (opens in new tab)`}>
            GitHub <span class="visually-hidden">(opens in new tab)</span>
          </a>
        </nav>
      </div>
    </header>

    <!-- Help Section (WCAG 2.2 Consistent Help) -->
    <aside class="help-section" role="complementary" aria-label="Help and accessibility">
      <details class="help-details">
        <summary class="help-summary touch-target" role="button">
          <span aria-hidden="true">‚ÑπÔ∏è</span> Help & Accessibility Options
        </summary>
        <div class="help-content">
          <h2 class="govuk-heading-s">Accessibility Features</h2>
          <ul class="govuk-list govuk-list--bullet">
            <li>Press Tab to navigate through interactive elements</li>
            <li>Press Ctrl + Plus/Minus to zoom in/out</li>
            <li>This page is screen reader optimized</li>
            <li>All images have descriptive text alternatives</li>
          </ul>
          <h2 class="govuk-heading-s">Quick Navigation</h2>
          <p class="govuk-body-s">Estimated reading time: 5 minutes</p>
          <p class="govuk-body-s">Number of sections: 5</p>
        </div>
      </details>
    </aside>

    <!-- Progress Indicator for Page Sections -->
    <nav class="progress-indicator" role="navigation" aria-label="Page sections">
      <p class="govuk-body-s">You are viewing: <strong id="current-section">Introduction</strong></p>
      <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-fill"></div>
      </div>
    </nav>

    <!-- Main content with ARIA label -->
    <main class="govuk-main-wrapper" id="main-content" role="main" aria-labelledby="site-title">
      
      <!-- Professional Experience Section -->
      <section class="govuk-section" id="experience" aria-labelledby="experience-heading" role="region">
        <h2 class="govuk-heading-l" id="experience-heading" tabindex="-1">Professional experience</h2>
        
        {experience.map((exp, index) => (
          <article class="govuk-!-margin-bottom-8" 
                   aria-label={`${exp.title} at ${exp.company}`}
                   role="article">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2" id={`exp-${index}`}>
              {exp.title}
            </h3>
            <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1"
               aria-describedby={`exp-${index}`}>
              {exp.company}
            </p>
            <p class="govuk-body-s govuk-text-colour--secondary govuk-!-margin-bottom-4">
              <time datetime={exp.period}>{exp.period}</time> ‚Ä¢ 
              <span aria-label="Location">{exp.location}</span>
            </p>
            <ul class="govuk-list govuk-list--bullet" role="list">
              {exp.points.map((point) => (
                <li role="listitem">{point}</li>
              ))}
            </ul>
          </article>
        ))}
      </section>

      <!-- Key Projects Section -->
      <section class="govuk-section" id="projects" aria-labelledby="projects-heading" role="region">
        <h2 class="govuk-heading-l" id="projects-heading" tabindex="-1">Key projects</h2>
        
        {projects.map((project) => (
          <article class="govuk-!-margin-bottom-7">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2">
              {project.name}
            </h3>
            <p class="govuk-body govuk-!-margin-bottom-3">
              {project.description}
            </p>
            
            <div class="govuk-!-margin-bottom-3">
              <p class="govuk-body-s govuk-!-font-weight-bold govuk-!-margin-bottom-2">
                Technologies used:
              </p>
              <div class="govuk-tag-list">
                {project.techStack.map((tech) => (
                  <span class="govuk-tag govuk-tag--grey">{tech}</span>
                ))}
              </div>
            </div>
            
            {project.achievements.length > 0 && (
              <div>
                <p class="govuk-body-s govuk-!-font-weight-bold govuk-!-margin-bottom-2">
                  Key achievements:
                </p>
                <ul class="govuk-list govuk-list--bullet govuk-list--spaced">
                  {project.achievements.map((achievement) => (
                    <li class="govuk-body-s">{achievement}</li>
                  ))}
                </ul>
              </div>
            )}
            
            {project.metrics && project.metrics.length > 0 && (
              <div class="govuk-inset-text govuk-!-margin-top-3">
                {project.metrics.map((metric) => (
                  <p class="govuk-body-s govuk-!-margin-bottom-1">{metric}</p>
                ))}
              </div>
            )}
          </article>
        ))}
      </section>

      <!-- Technical Skills Section -->
      <section class="govuk-section" id="skills" aria-labelledby="skills-heading" role="region">
        <h2 class="govuk-heading-l" id="skills-heading" tabindex="-1">Technical skills</h2>
        
        <div class="govuk-grid-row" role="list" aria-label="Skills by category">
          {Object.entries(skills).map(([category, skillList]) => (
            <div class="govuk-grid-column-one-half govuk-!-margin-bottom-6" role="listitem">
              <h3 class="govuk-heading-s govuk-!-margin-bottom-3" id={`skills-${category.replace(/\s+/g, '-').toLowerCase()}`}>
                {category}
              </h3>
              <div class="govuk-tag-list" role="list" aria-labelledby={`skills-${category.replace(/\s+/g, '-').toLowerCase()}`}>
                {skillList.map((skill) => (
                  <span class="govuk-tag govuk-tag--blue touch-target" role="listitem">{skill}</span>
                ))}
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- Education Section -->
      <section class="govuk-section" id="education" aria-labelledby="education-heading" role="region">
        <h2 class="govuk-heading-l" id="education-heading" tabindex="-1">Education</h2>
        
        {education.map((edu) => (
          <article class="govuk-!-margin-bottom-6" 
                   aria-label={`${edu.degree} from ${edu.institution}`}
                   role="article">
            <h3 class="govuk-heading-m govuk-!-margin-bottom-2" id={`edu-${edu.degree.replace(/\s+/g, '-').toLowerCase()}`}>
              {edu.degree}
            </h3>
            <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1"
               aria-describedby={`edu-${edu.degree.replace(/\s+/g, '-').toLowerCase()}`}>
              {edu.institution}
            </p>
            <p class="govuk-body-s govuk-text-colour--secondary govuk-!-margin-bottom-3">
              <time datetime={edu.period}>{edu.period}</time> ‚Ä¢ 
              <span aria-label="Location">{edu.location}</span>
            </p>
            {edu.grade && (
              <p class="govuk-body govuk-!-margin-bottom-3">
                <strong>Grade:</strong> {edu.grade}
              </p>
            )}
            {edu.modules && edu.modules.length > 0 && (
              <details class="govuk-details" data-module="govuk-details"
                       aria-label="Expand to view key modules studied">
                <summary class="govuk-details__summary touch-target"
                         role="button"
                         aria-expanded="false">
                  <span class="govuk-details__summary-text">
                    Key modules studied
                  </span>
                </summary>
                <div class="govuk-details__text">
                  <ul class="govuk-list govuk-list--bullet" role="list">
                    {edu.modules.map((module) => (
                      <li role="listitem">{module}</li>
                    ))}
                  </ul>
                </div>
              </details>
            )}
          </article>
        ))}
      </section>

      <!-- Certifications -->
      {certifications && certifications.length > 0 && (
        <section class="govuk-section" aria-labelledby="certifications-heading">
          <h2 class="govuk-heading-l" id="certifications-heading">Certifications</h2>
          
          <ul class="govuk-list govuk-list--bullet">
            {certifications.map((cert) => (
              <li class="govuk-!-margin-bottom-2">{cert}</li>
            ))}
          </ul>
        </section>
      )}
    </main>

    <!-- Footer with ARIA Landmarks -->
    <footer class="govuk-footer" role="contentinfo" aria-label="Site footer">
      <div class="govuk-footer__meta">
        <div class="govuk-footer__meta-item">
          <p class="govuk-footer__copyright">
            <small>¬© 2024 {personal.name}. All rights reserved.</small>
          </p>
        </div>
        <div class="govuk-footer__meta-item">
          <button class="govuk-button govuk-button--secondary touch-target" 
                  onclick="window.print()"
                  aria-label="Print this CV as PDF">
            <span aria-hidden="true">üñ®Ô∏è</span> Print this CV
          </button>
        </div>
      </div>
    </footer>
  </div>
</Layout>

<style>
  /* WCAG 2.2 Component Styles */
  .govuk-width-container {
    max-width: var(--max-width-page);
    margin: 0 auto;
    padding: 0 var(--spacing-3);
  }

  /* Ensure optimal line length for readability (45-75 characters) */
  .govuk-body,
  .govuk-body-l,
  .govuk-body-s,
  p, li {
    max-width: var(--max-width-content); /* 66ch optimal */
  }

  /* Skip Navigation Links (WCAG 2.2) */
  .skip-links {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1000;
  }

  .govuk-skip-link {
    position: absolute;
    left: -9999px;
    z-index: 999;
    padding: var(--spacing-2) var(--spacing-3);
    background: var(--color-focus);
    color: var(--color-focus-text);
    text-decoration: none;
    font-weight: 700;
    min-height: var(--target-size-recommended);
    display: flex;
    align-items: center;
  }

  .govuk-skip-link:focus,
  .govuk-skip-link:focus-visible {
    left: 0;
    outline: var(--focus-width) solid var(--color-focus-border);
    box-shadow: 0 0 0 var(--focus-offset) var(--color-focus);
  }

  /* Ensure 44x44 touch targets for all interactive elements */
  .touch-target {
    min-height: var(--target-size-recommended);
    min-width: var(--target-size-recommended);
    padding: var(--spacing-2) var(--spacing-3);
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Visually hidden but accessible to screen readers */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Separators for better visual structure */
  .separator {
    margin: 0 var(--spacing-2);
    color: var(--color-text-tertiary);
    user-select: none;
  }

  /* Help Section (WCAG 2.2 Consistent Help) */
  .help-section {
    position: fixed;
    top: var(--spacing-4);
    right: var(--spacing-4);
    z-index: 100;
    max-width: 300px;
  }

  .help-details {
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 4px;
    box-shadow: var(--shadow-md);
  }

  .help-summary {
    padding: var(--spacing-3);
    cursor: pointer;
    font-weight: 700;
    color: var(--color-link);
    list-style: none;
  }

  .help-summary::-webkit-details-marker {
    display: none;
  }

  .help-content {
    padding: var(--spacing-4);
    border-top: 1px solid var(--color-border);
  }

  /* Progress Indicator (Cognitive Accessibility) */
  .progress-indicator {
    position: sticky;
    top: 0;
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-2) 0;
    z-index: 50;
    margin-bottom: var(--spacing-4);
  }

  .progress-bar {
    height: 8px;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    overflow: hidden;
    margin-top: var(--spacing-2);
  }

  .progress-fill {
    height: 100%;
    background: var(--color-primary);
    width: 0%;
    transition: width 0.3s ease;
  }

  .govuk-header {
    padding: var(--spacing-6) 0;
    border-bottom: 10px solid var(--color-primary);
    margin-bottom: var(--spacing-6);
  }

  .govuk-heading-xl {
    font-size: var(--font-size-48);
    font-weight: 700;
    margin: 0 0 var(--spacing-4) 0;
    line-height: var(--line-height-tight);
  }

  .govuk-heading-l {
    font-size: var(--font-size-36);
    font-weight: 700;
    margin: var(--spacing-8) 0 var(--spacing-4) 0;
    line-height: var(--line-height-tight);
  }

  .govuk-heading-m {
    font-size: var(--font-size-24);
    font-weight: 700;
    margin: var(--spacing-6) 0 var(--spacing-3) 0;
    line-height: var(--line-height-tight);
  }

  .govuk-heading-s {
    font-size: var(--font-size-19);
    font-weight: 700;
    margin: var(--spacing-4) 0 var(--spacing-2) 0;
    line-height: var(--line-height-tight);
  }

  .govuk-body {
    font-size: var(--font-size-19);
    line-height: var(--line-height-normal);
    margin-bottom: var(--spacing-3);
  }

  .govuk-body-l {
    font-size: var(--font-size-24);
    line-height: var(--line-height-normal);
    margin-bottom: var(--spacing-4);
  }

  .govuk-body-s {
    font-size: var(--font-size-16);
    line-height: var(--line-height-normal);
    margin-bottom: var(--spacing-2);
  }

  .govuk-link {
    color: var(--color-link);
    text-underline-offset: 0.1em;
  }

  .govuk-link:visited {
    color: var(--color-link-visited);
  }

  .govuk-link:hover {
    color: var(--color-link-hover);
    text-decoration-thickness: 3px;
  }

  .govuk-link:focus {
    background-color: var(--color-focus);
    color: var(--color-text);
    outline: var(--focus-width) solid var(--color-focus);
    outline-offset: 0;
    text-decoration: none;
    box-shadow: 0 -2px var(--color-focus), 0 4px var(--color-text);
  }

  .govuk-list {
    padding-left: 20px;
    margin-bottom: var(--spacing-4);
  }

  .govuk-list--bullet {
    list-style-type: disc;
  }

  .govuk-list--spaced li {
    margin-bottom: var(--spacing-2);
  }

  .govuk-section {
    margin-bottom: var(--spacing-8);
    padding-bottom: var(--spacing-6);
    border-bottom: 1px solid var(--color-border);
  }

  .govuk-section:last-child {
    border-bottom: none;
  }

  .govuk-button-group {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0;
  }

  .govuk-tag {
    display: inline-block;
    padding: 4px 8px;
    margin-right: var(--spacing-2);
    margin-bottom: var(--spacing-2);
    font-size: var(--font-size-16);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 2px solid currentColor;
  }

  .govuk-tag--blue {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  .govuk-tag--grey {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border-color: var(--color-border);
  }

  .govuk-tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
  }

  .govuk-inset-text {
    padding: var(--spacing-3);
    border-left: 5px solid var(--color-border);
    background: var(--color-bg-secondary);
  }

  .govuk-details {
    margin-bottom: var(--spacing-4);
  }

  .govuk-details__summary {
    cursor: pointer;
    color: var(--color-link);
    text-underline-offset: 0.1em;
    display: inline-block;
    padding: var(--spacing-2) 0;
  }

  .govuk-details__summary:hover {
    color: var(--color-link-hover);
    text-decoration-thickness: 3px;
  }

  .govuk-details__summary:focus {
    outline: var(--focus-width) solid var(--color-focus);
    outline-offset: 0;
    background-color: var(--color-focus);
    color: var(--color-text);
  }

  .govuk-details__text {
    padding: var(--spacing-3) 0 var(--spacing-3) var(--spacing-4);
    border-left: 5px solid var(--color-border);
  }

  .govuk-footer {
    padding: var(--spacing-6) 0;
    border-top: 1px solid var(--color-border);
    margin-top: var(--spacing-8);
  }

  .govuk-footer__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }

  .govuk-button {
    /* WCAG 2.2: Ensure 44x44 minimum touch target */
    min-height: var(--target-size-recommended);
    min-width: var(--target-size-recommended);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--font-size-19);
    font-weight: 700;
    background: var(--color-success);
    color: white;
    border: 2px solid var(--color-success);
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
  }

  .govuk-button:hover {
    background: #00572e;
    border-color: #00572e;
  }

  .govuk-button:focus {
    outline: var(--focus-width) solid var(--color-focus);
    outline-offset: 0;
    background-color: var(--color-focus);
    color: var(--color-text);
    border-color: var(--color-text);
  }

  .govuk-button--secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border-color: var(--color-text);
  }

  .govuk-button--secondary:hover {
    background: var(--color-text);
    color: var(--color-bg);
  }

  /* GOV.UK Utility Classes */
  .govuk-!-margin-bottom-1 { margin-bottom: var(--spacing-1) !important; }
  .govuk-!-margin-bottom-2 { margin-bottom: var(--spacing-2) !important; }
  .govuk-!-margin-bottom-3 { margin-bottom: var(--spacing-3) !important; }
  .govuk-!-margin-bottom-4 { margin-bottom: var(--spacing-4) !important; }
  .govuk-!-margin-bottom-6 { margin-bottom: var(--spacing-6) !important; }
  .govuk-!-margin-bottom-7 { margin-bottom: var(--spacing-7) !important; }
  .govuk-!-margin-bottom-8 { margin-bottom: var(--spacing-8) !important; }
  
  .govuk-!-margin-top-3 { margin-top: var(--spacing-3) !important; }
  
  .govuk-!-margin-left-3 { margin-left: var(--spacing-3) !important; }
  .govuk-!-margin-right-3 { margin-right: var(--spacing-3) !important; }
  
  .govuk-!-font-weight-bold { font-weight: 700 !important; }
  
  .govuk-text-colour--secondary { 
    color: var(--color-text-secondary) !important; 
  }

  .govuk-grid-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
  }

  .govuk-grid-column-one-half {
    padding: 0 15px;
    width: 50%;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .govuk-heading-xl {
      font-size: var(--font-size-36);
    }

    .govuk-heading-l {
      font-size: var(--font-size-27);
    }

    .govuk-heading-m {
      font-size: var(--font-size-19);
    }

    .govuk-body-l {
      font-size: var(--font-size-19);
    }

    .govuk-body {
      font-size: var(--font-size-16);
    }

    .govuk-grid-column-one-half {
      width: 100%;
    }

    .govuk-button-group {
      flex-direction: column;
      align-items: flex-start;
    }

    .govuk-button-group span {
      display: none;
    }

    .govuk-footer__meta {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  /* Print styles */
  @media print {
    .govuk-skip-link,
    .govuk-button,
    .govuk-details__summary,
    .help-section,
    .progress-indicator,
    .skip-links {
      display: none !important;
    }

    .govuk-details__text {
      display: block !important;
      border: none !important;
      padding-left: 0 !important;
    }

    .govuk-header {
      border-bottom: 2px solid black !important;
    }

    .govuk-tag {
      border: 1px solid black !important;
      background: white !important;
      color: black !important;
    }
  }
</style>

<script>
  // Progress Indicator and Section Tracking (Cognitive Accessibility)
  document.addEventListener('DOMContentLoaded', () => {
    const sections = document.querySelectorAll('section[id]');
    const progressFill = document.querySelector('.progress-fill');
    const currentSectionLabel = document.getElementById('current-section');
    const progressBar = document.querySelector('.progress-bar');
    
    // Section names for better cognitive understanding
    const sectionNames = {
      'experience': 'Professional Experience',
      'projects': 'Key Projects',
      'skills': 'Technical Skills',
      'education': 'Education',
      'certifications': 'Certifications'
    };
    
    // Update progress on scroll
    const updateProgress = () => {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = (scrollTop / docHeight) * 100;
      
      if (progressFill) {
        progressFill.style.width = `${scrollPercent}%`;
        progressBar?.setAttribute('aria-valuenow', Math.round(scrollPercent).toString());
      }
      
      // Update current section
      sections.forEach(section => {
        const rect = section.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 100) {
          const sectionId = section.getAttribute('id');
          if (currentSectionLabel && sectionId) {
            currentSectionLabel.textContent = sectionNames[sectionId] || 'Introduction';
          }
        }
      });
    };
    
    // Smooth scroll for skip links
    document.querySelectorAll('.govuk-skip-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href')?.substring(1);
        const target = document.getElementById(targetId || '');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          target.focus();
        }
      });
    });
    
    // Update on scroll with throttling for performance
    let scrollTimer: number;
    window.addEventListener('scroll', () => {
      if (scrollTimer) {
        clearTimeout(scrollTimer);
      }
      scrollTimer = setTimeout(updateProgress, 10);
    });
    
    // Initial update
    updateProgress();
  });
  
  // Keyboard navigation enhancement
  document.addEventListener('keydown', (e) => {
    // Press 'H' to toggle help
    if (e.key === 'h' && !e.ctrlKey && !e.metaKey) {
      const helpDetails = document.querySelector('.help-details') as HTMLDetailsElement;
      if (helpDetails && document.activeElement?.tagName !== 'INPUT') {
        helpDetails.open = !helpDetails.open;
      }
    }
  });
</script>